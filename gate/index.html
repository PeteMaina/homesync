<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomeSync — Gate Log</title>
  <style>
    /* ---------- Palette & theme ---------- */
    :root{
      --bg-start: #0b1a1f;
      --bg-end:   #071017;
      /* brand blue shades (limited to 3 shades) */
      --brand-900: #0f2b4f;
      --brand-700: #1867ff; /* main accent */
      --brand-500: #67a7ff;
      --glass-opaque: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.06);
      --muted: rgba(255,255,255,0.6);
      --danger: #ff5252;
      --success: #4cd964;
      --card-radius: 14px;
      --soft-shadow: 14px 14px 30px rgba(0,0,0,0.6);
      --light-shadow: -8px -8px 20px rgba(255,255,255,0.03);
    }

    /* ---------- Page layout ---------- */
    html,body{
        width:100%;
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      /*background-image: url("images\ \(1\).jpg");/* background: #646463; ;/*linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);*/
      color: #001e57;
      background-color: aliceblue;
      overflow-y:auto;
    }

    input {
        color: #01172e;
        margin: 10px;
    }
    /* subtle top-left shine */
    body::before{
      content:"";
      position:fixed;
      left:-20%;
      top:-20%;
      width:70vmax;
      height:70vmax;
      background: radial-gradient(closest-side at 10% 10%, rgba(255,255,255,0.04), transparent 30%);
      z-index:0;
      pointer-events:none;
      filter: blur(18px);
      mix-blend-mode: screen;
    }

    .wrap{
      max-width:1200px;
      margin:38px auto;
      padding:28px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:24px;
      z-index:1;
      color:#01172e;
    }

    /* make it stack on small screens */
    @media (max-width:980px){
      .wrap{ grid-template-columns: 1fr; padding:18px; margin:16px; }
    }

    /* ---------- Glass card (neumorphic + glass) ---------- */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--card-radius);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(18px) saturate(90%);
      box-shadow: var(--soft-shadow), var(--light-shadow);
      padding:20px;
    }

    .title {
      font-size:20px;
      font-weight:700;
      letter-spacing: -0.2px;
      margin-bottom:14px;
    }
    .subtitle { color:var(--muted); font-size:13px; margin-bottom:18px; }

    form { display:flex; flex-direction:column; gap:12px; }

    label {
      display:block;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color: #0461d3;
    }

    .row { display:flex; gap:12px; }
    .row .field { flex:1; min-width:0; }

    .field input[type="text"],
    .field input[type="tel"],
    .field input[type="datetime-local"],
    .field input[type="number"]{
      width:100%;
      border-radius:12px;
      border: none;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.05));
      color: #01172e;
      box-shadow: inset 6px 6px 12px rgba(0,0,0,0.5), inset -4px -4px 8px rgba(255,255,255,0.01);
      outline: none;
      font-size:14px;
    }
    .field input::placeholder { color: rgba(15, 1, 48, 0.911); }

    /* pill button (Material 3 feel) */
    .btn {
      border: none;
      padding:12px 18px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      box-shadow: 6px 10px 20px rgba(8,12,30,0.7), -6px -6px 18px rgba(255,255,255,0.02);
      transition: transform .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btn:active { transform: translateY(1px) scale(.998); }

    .btn-primary{
      background: linear-gradient(180deg, var(--brand-700), var(--brand-700));
      color: rgb(16, 3, 75);
    }
    .btn-ghost{
      background: transparent;
      color: var(--brand-500);
      border: 1px solid rgba(255,255,255,0.04);
      padding:10px 14px;
      border-radius:999px;
    }

    /* signature area */
    .sig-pad {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      padding:8px;
    }
    canvas#sigCanvas {
      width:100%;
      height:160px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.006), rgba(0,0,0,0.1));
      touch-action: none;
    }

    /* right column visitor list */
    .list {
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:calc(100vh - 160px);
      overflow:auto;
      padding-right:6px;
    }
    .visitor {
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: 6px 6px 18px rgba(0,0,0,0.55);
    }
    .avatar {
      width:48px; height:48px; border-radius:10px; flex-shrink:0;
      background: linear-gradient(135deg, var(--brand-700), var(--brand-500));
      display:flex; 
      align-items:center; 
      justify-content:center; 
      font-weight:800;
      color:rgb(255, 255, 255); 
      font-size:18px;
      box-shadow: 2px 6px 14px rgba(0,0,0,0.5);
    }
    .vmeta { font-size:13px; color:#e7f2ff; }
    .muted { color: rgba(255,255,255,0.55); font-size:12px; }

    /* error & success cards (floating) */
    .toast {
      position: fixed;
      right: 22px;
      top: 22px;
      z-index: 9999;
      min-width:320px;
      border-radius:12px;
      padding:14px;
      display:none;
      color:rgb(1, 5, 54);
      box-shadow: 8px 18px 40px rgba(0,0,0,0.6), -4px -6px 18px rgba(255,255,255,0.02);
    }
    .toast.show { display:block; animation:toastIn .18s ease; }
    @keyframes toastIn { from { transform: translateY(-6px) scale(.995); opacity:0 } to { transform:none; opacity:1 } }

    .toast.error { background: linear-gradient(180deg, rgba(255,70,70,0.92), rgba(255,45,45,0.92)); }
    .toast.success { background: linear-gradient(180deg, rgba(60,190,120,0.94), rgba(40,170,100,0.94)); }

    .small { font-size:12px; opacity:0.95; }

    /* small helpers */
    .inline { display:inline-flex; gap:8px; align-items:center; }
    .gap { height:8px; }

  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Form -->
    <section class="card">
      <div class="title">Gate — Visitor Entry</div>
      <div class="subtitle">Clear and Consice</div>

      <form id="visitorForm" autocomplete="off">
        <div class="row">
          <div class="field">
            <label for="full_name">Full name <span style="color:#01172e;">*</span></label>
            <input id="full_name" name="full_name" type="text" placeholder="e.g. George Njamula" required style="color:#01172e;"/>
          </div>

          <br>

          <div class="field">
            <label for="citizen_id">ID Number</label>
            <input id="citizen_id" name="citizen_id" type="text" placeholder="ID / Passport no." required />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="phone_number">Phone number </label>
            <input id="phone_number" name="phone_number" type="tel" placeholder="+2547..." />
          </div>

          <div class="field">
            <label for="number_plate">Car reg (optional)</label>
            <input id="number_plate" name="number_plate" type="text" placeholder="KDS 003A" />
          </div>

        </div>

        <div class="row">
            <div>
                    <div class="field">
                        <label for="house_number">House number visited <span style="color:var(--brand-500)">*</span></label>
                        <input id="house_number" name="house_number" type="text" placeholder="House # or Flat # (e.g. B12)" required />
                    </div>
            </div>
          <br>
          <div class="field">
            <label for="time_in">Time in <span style="color:var(--brand-500)">*</span></label>
            <input id="time_in" name="time_in" type="datetime-local" required/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="time_out">Time out </label>
            <input id="time_out" name="time_out" type="datetime-local" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="display:flex; gap:8px;">
              <button type="button" class="btn btn-ghost" id="fillNow">Set Now</button>
              <button type="button" class="btn btn-ghost" id="clearTimes">Clear</button>
            </div>
          </div>
        </div>

        <div>
          <label>Signature </label>
          <div class="sig-pad">
            <canvas id="sigCanvas"></canvas>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button type="button" id="sigClear" class="btn btn-ghost">Clear</button>
              <button type="button" id="sigUndo" class="btn btn-ghost">Undo</button>
            </div>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <span class="muted small">Fields with * are required</span>
          </div>
          <div>
            <button type="submit" class="btn btn-primary" id="submitBtn">Log visitor</button>
          </div>
        </div>
      </form>
    </section>

    <!-- RIGHT: Recent visitors -->
    <aside class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div class="title">Recent visitors</div>
          <div class="subtitle">Live list — updates on submit</div>
        </div>
        <div><button id="refreshList" class="btn btn-ghost">Refresh</button></div>
      </div>

      <div class="list" id="visitorList" aria-live="polite"></div>
    </aside>
  </div>

  <!-- Toast messages -->
  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

<script>
/* ---------- Utilities & configuration ---------- */
const API_CREATE = '/api/visitor_create.php';
const API_LIST   = '/api/visitors_list.php';

function showToast(message, type='error', timeout=4000){
  const el = document.getElementById('toast');
  el.className = 'toast show ' + (type === 'success' ? 'success' : 'error');
  el.innerHTML = `<strong style="display:block;margin-bottom:6px;">${ type === 'success' ? 'Success' : 'Error' }</strong>
                  <div class="small">${message}</div>`;
  if (timeout) setTimeout(() => el.classList.remove('show'), timeout);
}

/* ---------- Signature pad (simple) ---------- */
class SignaturePadSimple {
  constructor(canvas){
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this._resize();
    this._initEvents();
    this._points = [];
    window.addEventListener('resize', () => this._resize());
    this.clear();
  }
  _resize(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const w = this.canvas.clientWidth;
    const h = this.canvas.clientHeight;
    this.canvas.width = Math.floor(w * ratio);
    this.canvas.height = Math.floor(h * ratio);
    this.ctx.scale(ratio, ratio);
    this.ctx.lineCap = 'round';
    this.ctx.lineJoin = 'round';
    this.ctx.lineWidth = 2.8;
    this.redraw();
  }
  _initEvents(){
    let drawing = false;
    let last = null;

    const getPos = (ev) => {
      if (ev.touches && ev.touches[0]) {
        const rect = this.canvas.getBoundingClientRect();
        return { x: ev.touches[0].clientX - rect.left, y: ev.touches[0].clientY - rect.top };
      } else {
        const rect = this.canvas.getBoundingClientRect();
        return { x: ev.clientX - rect.left, y: ev.clientY - rect.top };
      }
    };

    const start = (ev) => { ev.preventDefault(); drawing = true; last = getPos(ev); this._points.push({type:'begin', p:last}); };
    const move  = (ev) => { if(!drawing) return; ev.preventDefault(); const p = getPos(ev); this._points.push({type:'pt', p}); this._drawLine(last, p); last = p; };
    const end   = (ev) => { if(!drawing) return; ev.preventDefault(); drawing=false; this._points.push({type:'end'}); };

    this.canvas.addEventListener('mousedown', start);
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', end);
    this.canvas.addEventListener('touchstart', start, {passive:false});
    document.addEventListener('touchmove', move, {passive:false});
    document.addEventListener('touchend', end);
  }
  _drawLine(a, b){
    this.ctx.beginPath();
    this.ctx.moveTo(a.x, a.y);
    this.ctx.lineTo(b.x, b.y);
    this.ctx.strokeStyle = 'rgba(255,255,255,0.95)';
    this.ctx.lineWidth = 2.6;
    this.ctx.stroke();
    this.ctx.closePath();
  }
  redraw(){
    // replay points
    this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    this.ctx.beginPath();
    for(let i=0;i<this._points.length;i++){
      const e = this._points[i];
      if (e.type === 'begin') { this.last = e.p; continue; }
      if (e.type === 'pt' && this.last) { this._drawLine(this.last, e.p); this.last = e.p; }
      if (e.type === 'end') this.last = null;
    }
  }
  toDataURL(){
    // if pad empty return null
    if (this._points.length === 0) return null;
    // trim whitespace: draw on a temp canvas to shrink? (skipping trimming for brevity)
    return this.canvas.toDataURL('image/png');
  }
  clear(){
    this._points = [];
    const ctx = this.ctx;
    ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    // subtle placeholder stroke
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fillRect(0,0,this.canvas.width, this.canvas.height);
  }
  undo(){
    // remove last stroke block (from last 'begin' to end)
    // quick approach: pop until last 'begin' removed
    for(let i=this._points.length-1;i>=0;i--){
      const e = this._points[i];
      this._points.splice(i,1);
      if (e.type === 'begin') break;
    }
    this.redraw();
  }
}

/* ---------- Form handling ---------- */
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('visitorForm');
  const sigCanvas = document.getElementById('sigCanvas');
  // set canvas height in CSS-like pixels (since we used 100% width it will size itself)
  sigCanvas.style.height = '160px';
  const sigPad = new SignaturePadSimple(sigCanvas);

  document.getElementById('sigClear').addEventListener('click', () => sigPad.clear());
  document.getElementById('sigUndo').addEventListener('click', () => sigPad.undo());
  document.getElementById('fillNow').addEventListener('click', () => {
    const now = new Date();
    const tzOffset = now.getTimezoneOffset() * 60000;
    const localISO = new Date(now - tzOffset).toISOString().slice(0,16);
    document.getElementById('time_in').value = localISO;
  });
  document.getElementById('clearTimes').addEventListener('click', () => {
    document.getElementById('time_in').value = '';
    document.getElementById('time_out').value = '';
  });

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    document.getElementById('submitBtn').disabled = true;

    // gather data
    const payload = {
      full_name: document.getElementById('full_name').value.trim(),
      citizen_id: document.getElementById('citizen_id').value.trim() || null,
      phone_number: document.getElementById('phone_number').value.trim() || null,
      number_plate: document.getElementById('number_plate').value.trim() || null,
      house_number: document.getElementById('house_number').value.trim(),
      time_in: document.getElementById('time_in').value || null,
      time_out: document.getElementById('time_out').value || null,
      signature: sigPad.toDataURL() // returns null if empty
    };

    // client validation
    if (!payload.full_name || !payload.house_number) {
      showToast('Please fill required fields: Full name and House number.', 'error', 5000);
      document.getElementById('submitBtn').disabled = false;
      return;
    }

    // our UI shows errors as toasts/cards, not alert()
    try {
      const res = await fetch(API_CREATE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const body = await res.json();

      if (!res.ok || body.error) {
        showToast(body.error || 'Server returned an error.', 'error', 7000);
      } else {
        showToast('Visitor logged successfully.', 'success', 3000);
        form.reset();
        sigPad.clear();
        loadVisitors(); // refresh list
      }
    } catch (err) {
      showToast('Network/Server error. Check console for details.', 'error', 7000);
      console.error(err);
    } finally {
      document.getElementById('submitBtn').disabled = false;
    }
  });

  document.getElementById('refreshList').addEventListener('click', loadVisitors);

  loadVisitors(); // initial load
  // optional: live refresh every 12s
  setInterval(loadVisitors, 12000);

  async function loadVisitors() {
    try {
      const res = await fetch(API_LIST);
      const data = await res.json();
      if (data.error) {
        showToast('Failed to load visitors: ' + data.error, 'error', 6000);
        return;
      }
      const cont = document.getElementById('visitorList');
      cont.innerHTML = '';
      if (!data.length) {
        cont.innerHTML = `<div class="muted">No visitors logged yet.</div>`;
        return;
      }
      data.forEach(v => {
        const avatarTxt = (v.full_name || 'Visitor').split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
        const timeIn = v.time_in ? new Date(v.time_in).toLocaleString() : '';
        const timeOut = v.time_out ? new Date(v.time_out).toLocaleString() : '';
        const tenant = v.tenant_name ? `<div class="muted">Tenant: ${v.tenant_name}</div>` : '';
        const plate = v.number_plate ? `<div class="muted">Plate: ${v.number_plate}</div>` : '';
        const phone = v.phone_number ? `<div class="muted">Phone: ${v.phone_number}</div>` : '';
        const signBtn = v.signature_url ? `<a href="${v.signature_url}" target="_blank" class="muted">View signature</a>` : '';

        const el = document.createElement('div');
        el.className = 'visitor';
        el.innerHTML = `
          <div class="avatar">${avatarTxt}</div>
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
              <div style="font-weight:700;">${escapeHtml(v.full_name)}</div>
              <div class="muted small">${timeIn}</div>
            </div>
            <div class="vmeta">${escapeHtml(v.house_number)}</div>
            <div style="display:flex; gap:12px; margin-top:6px; flex-wrap:wrap;">
              ${tenant}
              ${phone}
              ${plate}
              ${signBtn}
            </div>
          </div>
        `;
        cont.appendChild(el);
      });
    } catch (err) {
      console.error(err);
      showToast('Failed to fetch visitors list.', 'error', 6000);
    }
  }

  function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"'`=\/]/g, function(c){ return '&#'+c.charCodeAt(0)+';'; }); }
});
</script>
</body>
</html>
